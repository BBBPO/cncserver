<!DOCTYPE html>
<html>
  <head>
    <script src="/resources/jquery.js"></script>
    <script src="/resources/jquery.svg.js"></script>
    <script src="/resources/jquery.svgdom.js"></script>
    <link rel="stylesheet" href="/resources/styles.css">
  </head>
<body>

<nav id="control">
  <button id="park">Park</button>
  <button id="movefirst" disabled>Move to First point</button>
  <button id="draw" disabled>Draw Path</button>
  <button id="pen-up">Brush Up</button>
  <button id="pen-down">Brush Down</button>
  <button id="disable">Unlock/Disable Motors</button>
  <select id="precision" title="Trace precision: Default is 'Fine'">
    <option value="0.1">Super-fine (0.1)</option>
    <option value="0.4">Very Fine (0.4)</option>
    <option value="1" selected>Fine* (1)</option>
    <option value="3">Coarse (3)</option>
    <option value="5">Very Coarse (5)</option>
  </select>
</nav>

<nav id="fills">
  <button id="fill-build" disabled>Build Fill</button>
  <select>
    <option value="horizontal">Horizontal</option>
    <option value="vertical">Vertical</option>
    <option value="path">Spiral</option>
  </select>
  <button id="fill-paint" disabled>Paint Fill</button>
  <progress max="100" value="0"></progress>
</nav>

<nav id="tools">
  <a id="water0" class="water" href="#">Water 1</a>
  <a id="water1" class="water" href="#">Water 2</a>
  <a id="water2" class="water" href="#">Water 3</a>
  <a id="color0" class="color colorset1" href="#">Brown</a>
  <a id="color1" class="color colorset1" href="#">Violet</a>
  <a id="color2" class="color colorset1" href="#">Blue</a>
  <a id="color3" class="color colorset1" href="#">Green</a>
  <a id="color4" class="color colorset1" href="#">Yellow</a>
  <a id="color5" class="color colorset1" href="#">Orange</a>
  <a id="color6" class="color colorset1" href="#">Red</a>
  <a id="color7" class="color colorset1 selected" href="#">Black</a>
</nav>

<nav id="paths"><ul></ul></nav>

<svg id="main" xmlns="http://www.w3.org/2000/svg" version="1.1" height="738" width="1000">
  <g
     id="layer1"
     transform="translate(940.5858422,8.78524) rotate(90) scale(0.95)">
    <g
       id="g6432"
       transform="matrix(10.332556,0,0,10.332556,-5145.7248,-8136.77)">
      <path
         d="m 563.483,829.094 c 0,-3.943 2.252,-6.484 2.252,-11.663 0,-4.732 -2.071,-8.484 -1.67,-11.133 0.401,-2.649 3.712,-4.082 3.712,-4.082 l -6.123,-7.053 c 0,0 -2.65,5.195 -5.993,5.195 -2.779,0 -4.967,-2.879 -7.817,-3.307 -3.815,-0.573 -9.386,2.751 -9.386,2.751 0,0 8.114,-5.592 4.452,-7.423 -2.968,-1.484 -7.051,7.161 -7.051,7.161 0,0 1.861,-9.943 -1.49,-9.943 -3.353,0 -0.737,9.798 -0.737,9.798 0,0 -4.265,-8.501 -7.237,-6.831 -2.823,1.59 5.567,7.268 5.567,7.268 0,0 -7.297,-3.306 -10.631,-3.163 -4.646,0.201 -3.951,2.761 -8.201,2.761 -2.86,0 -4.028,-5.595 -4.028,-5.595 l -9.704,8.748 c 0,0 4.431,1.884 5.205,4.271 1.566,4.823 -2.331,6.691 -2.331,10.393 0,6.31 2.97,8.947 2.97,12.246 0,3.46 -6.497,6.124 -6.497,6.124 0,0 7.193,2.007 7.193,5.012 0,4.267 -3.479,5.905 -3.479,10.577 0,5.752 3.896,5.379 3.188,9.647 -0.428,2.583 -5.973,6.867 -5.973,6.867 l 8.688,8.673 c 0,0 2.827,-4.205 5.786,-4.205 2.97,0 5.283,2.583 8.164,2.583 3.337,0 5.214,-2.596 7.795,-2.596 3.335,0 5.382,5.382 5.382,5.382 0,0 1.38,-5.514 6.309,-5.514 1.521,0 3.711,2.356 6.865,2.356 3.155,0 4.863,-2.648 7.609,-2.648 2.41,0 4.921,4.642 4.921,4.642 l 8.255,-7.932 c 0,0 -5.383,-2.226 -5.383,-5.009 0,-3.104 1.856,-4.454 1.856,-10.577 0,-7.237 -2.15,-8.051 -2.15,-13.102 0,-2.261 5.104,-4.143 5.104,-4.143 0,0 -5.392,-0.815 -5.392,-6.536 z"
         id="frame"
         inkscape:connector-curvature="0"
         style="fill:#665440" />
      <polygon
         points="560.964,803.779 507.902,802.554 508.722,868.837 560.964,868.02 "
         id="polygon480"
         style="fill:#ffeb8c" />
      <polygon
         points="560.215,804.763 508.788,803.603 509.562,867.788 560.215,867.017 "
         id="polygon482"
         style="fill:#c7a941" />
      <polygon
         points="560.215,832.603 509.139,832.603 509.562,867.788 560.215,867.017 "
         id="polygon484"
         style="fill:#824830" />
      <path
         d="m 509.139,832.603 h 51.076 v -4.743 c 0,0 -2.369,3.197 -4.058,3.197 -2.322,0 -4.1,-4.931 -6.573,-4.931 -2.475,0 -5.22,5.896 -5.22,5.896 l -19.143,-0.774 c 0,0 -3.673,-9.278 -5.8,-9.278 -1.161,0 -3.285,4.64 -3.285,4.64 0,0 -3.094,-8.121 -4.642,-8.121 -0.854,0 -1.802,2.128 -2.479,4.032 l 0.124,10.082 z"
         id="path486"
         inkscape:connector-curvature="0"
         style="fill:#596b30" />
      <path
         d="m 514.588,832.964 c 0,0 -4.903,0.22 -4.903,1.765 0,1.546 5.969,0.82 5.969,2.37 0,1.545 -4.435,1.4 -4.424,2.754 0.024,2.682 10.247,1.062 10.247,1.062 0,0 -7.734,-0.676 -7.734,-1.642 0,-0.968 4.179,-1.233 4.179,-2.394 0,-1.306 -6.98,-1.135 -6.98,-2.15 -0.002,-1.114 3.646,-1.765 3.646,-1.765 z"
         id="path488"
         inkscape:connector-curvature="0"
         style="fill:#433225" />
      <path
         d="m 554.988,833.559 c 0,0 -2.554,0.113 -2.554,0.918 0,0.807 3.107,0.428 3.107,1.234 0,0.804 -2.309,0.729 -2.302,1.432 0.012,1.395 5.333,0.553 5.333,0.553 0,0 -4.023,-0.351 -4.023,-0.853 0,-0.505 2.174,-0.644 2.174,-1.245 0,-0.68 -3.634,-0.592 -3.634,-1.121 10e-4,-0.576 1.899,-0.918 1.899,-0.918 z"
         id="path490"
         inkscape:connector-curvature="0"
         style="fill:#433225" />
      <path
         d="m 521.378,844.216 c 0,0 6.644,-2.708 2.466,-9.945 -2.987,-5.176 0,-12.663 0,-12.663 0,0 -0.358,-5.733 1.529,-8.63 2.09,-3.2 4.734,-5.012 8.578,-5.012 8.848,0 12.021,4.701 12.021,16.885 0,12.354 2.507,16.101 2.507,16.101 l -27.101,3.264 z"
         id="path492"
         inkscape:connector-curvature="0"
         style="fill:#433225" />
      <path
         d="m 551.956,865.953 v -4.893 c 7.623,-4.737 1.306,-12.882 -1.368,-16.177 -5.006,-6.175 -13.522,-7.414 -13.522,-13.256 0,-5.343 4.453,-9.187 1.671,-16.146 -1,-2.497 -7.516,-4.592 -7.516,-4.592 l -4.037,2.228 c -1.529,0.974 -2.202,9.183 0.418,12.944 2.133,3.062 4.038,3.248 4.038,3.248 v 5.239 c 0,0 -5.985,2.923 -11.598,9.498 -4.994,5.854 -7.204,18.979 -7.453,22.861 l 39.367,-0.954 z"
         id="path494"
         inkscape:connector-curvature="0"
         style="fill:#f4d37e" />
      <path
         d="m 559.088,867.035 c -0.147,-1.987 -0.645,-8.715 -2.26,-13.557 -2.028,-6.089 -4.85,-9.744 -10.717,-14.476 0,0 -5.01,7.794 -15.03,7.794 -4.355,0 -7.375,-4.87 -5.708,-8.629 -0.895,0.796 -4.452,4.888 -5.331,5.88 -4.603,5.227 -7.542,14.581 -7.542,23.703 l 46.588,-0.715 z"
         id="path496"
         inkscape:connector-curvature="0"
         style="fill:#433225" />
      <path
         d="m 520.96,844.801 0.011,14.108 c 0,0 4.774,-1.277 10.053,-0.208 0,0 -2.322,1.74 -4.062,4.206 -1.489,2.109 -2.175,4.351 -2.175,4.351"
         id="path498"
         inkscape:connector-curvature="0"
         style="fill:none;stroke:#000000;stroke-width:0.55669999" />
      <path
         d="m 548.229,843.913 c 0,0 -0.771,2.128 -1.74,7.637 -0.693,3.949 -0.822,8.618 -0.822,8.618"
         id="path500"
         inkscape:connector-curvature="0"
         style="fill:none;stroke:#000000;stroke-width:0.55669999" />
      <path
         d="m 529.758,824.797 c 0,0 0.827,0.803 1.74,0.772 1.169,-0.033 1.781,-0.767 1.781,-0.767"
         id="path502"
         inkscape:connector-curvature="0"
         style="fill:none;stroke:#000000;stroke-width:0.41339999;stroke-linecap:round" />
      <path
         d="m 533.143,818.099 c 0.518,-0.404 1.169,-0.635 1.831,-0.585 0.641,0.051 1.16,0.349 1.492,0.799"
         id="path504"
         inkscape:connector-curvature="0"
         style="fill:none;stroke:#000000;stroke-width:0.28490001;stroke-linecap:round" />
      <path
         d="m 552.774,863.827 c 0,0 -2.819,-2.301 -6.882,-2.825 -3.221,-0.419 -8.007,-0.282 -11.053,0.347 -3.652,0.75 -4.834,1.935 -4.834,1.935"
         id="path506"
         inkscape:connector-curvature="0"
         style="fill:none;stroke:#000000;stroke-width:0.41819999" />
      <path
         d="m 546.524,859.932 c 0,0 1.748,-0.375 3.566,-0.377 1.698,-0.007 3.409,0.446 3.409,0.446"
         id="path508"
         inkscape:connector-curvature="0"
         style="fill:none;stroke:#000000;stroke-width:0.55669999" />
      <path
         d="m 538.129,861.963 c 0,0 -0.743,-2.492 -3.701,-2.827 -3.027,-0.343 -8.312,4.907 -6.274,6.235 3.551,2.324 9.975,-3.408 9.975,-3.408 z"
         id="path510"
         inkscape:connector-curvature="0"
         style="fill:#f5c14c" />
      <line
         x1="534.315"
         y1="862.97998"
         x2="530.328"
         y2="865.44397"
         id="line512"
         style="fill:none;stroke:#000000;stroke-width:0.28999999;stroke-linecap:round" />
      <line
         x1="531.70502"
         y1="861.31097"
         x2="528.008"
         y2="864.06897"
         id="line514"
         style="fill:none;stroke:#000000;stroke-width:0.28999999;stroke-linecap:round" />
      <line
         x1="533.51599"
         y1="861.74902"
         x2="528.80499"
         y2="865.08301"
         id="line516"
         style="fill:none;stroke:#000000;stroke-width:0.28999999;stroke-linecap:round" />
      <path
         d="m 529.853,860.634 c 0,0 0.735,-1.933 4.229,-2.006 3.049,-0.062 8.69,5.125 6.653,6.454 -3.551,2.321 -10.882,-4.448 -10.882,-4.448 z"
         id="path518"
         inkscape:connector-curvature="0"
         style="fill:#f5df88" />
      <line
         x1="534.57501"
         y1="862.68903"
         x2="538.56097"
         y2="865.15601"
         id="line520"
         style="fill:none;stroke:#000000;stroke-width:0.35049999;stroke-linecap:round" />
      <line
         x1="537.18402"
         y1="861.02301"
         x2="540.883"
         y2="863.77698"
         id="line522"
         style="fill:none;stroke:#000000;stroke-width:0.35049999;stroke-linecap:round" />
      <line
         x1="535.37299"
         y1="861.45697"
         x2="540.08398"
         y2="864.79102"
         id="line524"
         style="fill:none;stroke:#000000;stroke-width:0.35049999;stroke-linecap:round" />
      <line
         x1="535.70502"
         y1="865.10797"
         x2="537.14398"
         y2="867.08398"
         id="line526"
         style="fill:none;stroke:#8a4d4a;stroke-width:0.35049999;stroke-linecap:round" />
      <path
         d="m 527.114,818.174 c 0,0 1.322,-0.743 2.575,-0.381 1.533,0.442 1.347,1.725 1.347,2.516 0,1.343 -1,2.713 -1,2.713 0,0 0.406,0.137 1.178,0.137 0.771,0 1.169,-0.091 1.169,-0.091"
         id="path528"
         inkscape:connector-curvature="0"
         style="fill:none;stroke:#000000;stroke-width:0.28490001;stroke-linecap:round" />
      <line
         x1="529.19"
         y1="818.44202"
         x2="529.19"
         y2="819.39099"
         id="line530"
         style="fill:none;stroke:#000000;stroke-width:0.55669999;stroke-linecap:round" />
      <line
         x1="534.93298"
         y1="818.44202"
         x2="534.93298"
         y2="819.39099"
         id="line532"
         style="fill:none;stroke:#000000;stroke-width:0.55669999;stroke-linecap:round" />
      <path
         d="m 547.735,841.183 -8.164,4.27 c 5.429,-5.891 0.695,-8.954 0.695,-8.954 l 5.149,-3.759 2.32,8.443 z"
         id="path534"
         inkscape:connector-curvature="0"
         style="fill:#433225" />
      <path
         d="m 548.479,840.952 c 0,0 -3.709,0.419 -8.907,4.501 -5.81,4.566 -8.907,11.133 -8.907,11.133"
         id="path536"
         inkscape:connector-curvature="0"
         style="fill:none;stroke:#000000;stroke-width:0.55669999;stroke-linecap:round" />
    </g>
  </g>

  <path
       d="m 177.14285,215.21933 c 0.69835,1.09589 -1.13269,1.48203 -1.82143,1.16071 -1.86645,-0.87079 -1.62493,-3.45509 -0.49998,-4.80358 2.01228,-2.41213 5.74105,-1.92078 7.78571,0.16075 3.00064,3.05474 2.23295,8.06074 -0.82147,10.76786 -4.07108,3.60816 -10.39277,2.55251 -13.75,-1.48221 -4.22473,-5.07729 -2.87599,-12.73075 2.14294,-16.73213 6.0786,-4.84621 15.07212,-3.20177 19.71427,2.80366 5.47062,7.07719 3.52897,17.41559 -3.46439,22.69641 -8.07412,6.09692 -19.76048,3.85714 -25.67855,-4.12512 -6.7245,-9.06995 -4.18598,-22.10634 4.78585,-28.66069 10.06503,-7.35299 24.45293,-4.5153 31.64283,5.44658 7.98214,11.05957 4.84499,26.80006 -6.10731,34.62497 -12.05371,8.61181 -29.14761,5.17495 -37.60711,-6.76804 -9.24188,-13.04754 -5.50514,-31.49548 7.42876,-40.58925 14.04113,-9.87225 33.84363,-5.83549 43.57139,8.08949 10.50287,15.03454 6.166,36.19198 -8.75022,46.55353 -16.02777,11.1337 -38.54051,6.49661 -49.53566,-9.41094 -11.76469,-17.0209 -6.82732,-40.88919 10.07167,-52.51781 18.01391,-12.39583 43.23799,-7.15811 55.49995,10.7324 13.02707,19.00684 7.48897,45.5869 -11.39313,58.48209 -19.99969,13.65843 -47.9359,7.81989 -61.46423,-12.05386 -14.28987,-20.99248 -8.15086,-50.28497 12.71459,-64.44637 21.98521,-14.92138 52.63411,-8.48187 67.4285,13.37532 15.55297,22.97789 8.81292,54.98332 -14.03604,70.41064 -23.97054,16.18461 -57.33258,9.14401 -73.39279,-14.69677 -16.81629,-24.96315 -9.47511,-59.68188 15.3575,-76.37492 25.95573,-17.44803 62.03123,-9.80626 79.35707,16.01823 18.0798,26.94827 10.13742,64.3806 -16.67896,82.3392 -27.94079,18.7116 -66.73002,10.46861 -85.32134,-17.33968 -19.34345,-28.93329 -10.79981,-69.07947 18.00041,-88.30349 29.92577,-19.97531 71.42894,-11.13103 91.28563,18.66114 20.6072,30.91823 11.46226,73.77844 -19.32187,94.26777 -31.91067,21.23912 -76.12796,11.79352 -97.24991,-19.9826 -21.871063,-32.9031 -12.12478,-78.4775 20.64333,-100.23204 33.89551,-22.50303 80.82705,-12.45606 103.21418,21.30405 23.135,34.88791 12.78735,83.17663 -21.96478,106.19632 -35.8803,23.767 -85.52622,13.11864 -109.17846,-22.62551 -24.399007,-36.87268 -13.449948,-87.87582 23.28624,-112.1606 37.86504,-25.03103 90.22544,-13.78126 115.14274,23.94697 25.66306,38.8574 14.11258,92.57507 -24.6077,118.12488 -39.84976,26.29511 -94.92471,14.4439 -121.10702,-25.26843 -26.927167,-40.8421 -14.77524,-97.27436 25.92915,-124.08916 41.83444,-27.55923 99.62403,-15.10658 127.0713,26.58988 28.19132,42.82677 15.43793,101.9737 -27.25061,130.05344 C 184.39481,324.18582 123.89052,311.1317 95.178325,267.45109 65.722829,222.63968 79.077688,160.77802 123.75039,131.43337 c 45.80372,-30.0876 109.02276,-16.432 138.99986,29.23279 30.71971,46.79603 16.76336,111.37247 -29.89352,141.982 C 185.06839,333.99999 119.13455,319.74289 87.892589,272.09391 55.90864,223.31328 70.466481,156.02202 119.10757,124.14763 168.88049,91.531554 237.52918,106.39015 270.03598,156.02334 303.2842,206.78855 288.12485,276.79468 237.49955,309.9339 185.74205,343.81425 114.37848,328.35415 80.606853,276.73673 46.094354,223.98695 61.855216,151.26592 114.46474,116.8619 168.20681,81.717247 242.2853,97.778869 277.32172,151.38052 313.09852,206.11486 296.73614,281.55081 242.14237,317.21963 186.41576,353.62859 109.62232,336.96545 73.321117,281.37956 36.279992,224.66067 53.243904,146.50975 109.82192,109.57616 167.53307,71.902868 247.04148,89.167546 284.60746,146.73769 322.91292,205.44111 305.34747,286.30702 246.7852,324.50537 187.08952,363.443 104.86611,345.57679 66.035381,286.02238 26.465568,225.33444 44.632554,141.75352 105.1791,102.29042 166.8593,62.088431 251.79773,80.556189 291.89319,142.09487 332.72737,204.76733 313.95884,291.06327 251.42802,331.7911 187.76331,373.25747 100.10984,354.18816 58.749645,290.6652 16.651094,226.00824 36.021174,136.99724 100.53628,95.004689 166.18549,52.273946 256.55402,71.944802 299.17893,137.45205 342.54186,204.09351 322.57023,295.81957 256.07084,339.07684 188.43713,383.07197 95.353528,362.79956 51.46391,295.30802 6.8365789,226.68207 27.409769,132.24092 95.893452,87.718953 165.51165,42.459421 261.31035,63.333391 306.46466,132.80922 352.3564,203.41967 331.18165,300.57591 260.71366,346.36257 189.11098,392.88651 90.59718,371.41098 44.178174,299.95085 -2.977971,227.35592 18.798343,127.48457 91.250629,80.433217 164.8378,32.644864 266.06671,54.72196 313.7504,128.1664 362.17096,202.74581 339.79308,305.33228 265.35649,353.64831 189.78485,402.70109 85.840803,380.02242 36.892438,304.59367 -12.79255,228.02979 10.186899,122.72818 86.607806,73.147481 164.16392,22.830278 270.8231,46.110512 321.03614,123.52358 371.98555,202.07192 348.40453,310.08868 269.99931,360.93405 190.45873,412.51568 81.084399,388.63388 29.606702,309.23649 -22.607154,228.70368 1.5754393,117.97177 81.964984,65.861745 163.49002,13.015668 275.57952,37.499049 328.32187,118.88075 381.80017,201.39803 357.016,314.8451 274.64213,368.21978 191.13263,422.3303 76.327973,397.24535 22.320966,313.87932 -32.42178,229.37759 -7.0360332,113.21534 77.322161,58.576009 162.81612,3.2010378 280.33595,28.887574 335.60761,114.23793 391.61481,200.72411 365.62748,319.60154 279.28496,375.50552 191.80655,432.14494 71.571528,405.85683 15.03523,318.52214 -42.236424,230.05151 -15.647517,108.45889 72.679338,51.290274 162.1422,-6.6136105 285.09241,20.276087 342.89334,109.59511 401.42946,200.05019 374.23897,324.358 283.92778,382.79125 192.48047,441.9596 66.815067,414.46832 7.7494946,323.16496 -52.051084,230.72543 -24.259011,103.70243 68.036515,44.004538 161.46826,-16.428274 289.84888,11.664591 350.17908,104.95229 411.24413,199.37626 382.85047,329.11447 288.5706,390.07699 193.15441,451.77427 62.058591,423.07982 0.46375879,327.80778 -61.865758,231.39937 -32.870513,98.945947 63.393692,36.718802 160.79432,-26.242952 294.60536,3.0530869 357.46481,100.30946 c 63.594,98.39285 33.99716,233.5615 -64.25138,297.05327 C 193.82836,461.58896 57.302101,431.69133 -6.821977,332.45061 -71.680445,232.07332 -41.482023,94.189454 58.750869,29.433066 160.12037,-36.057642 299.36185,-5.558425 364.75055,95.66664 430.8735,198.02836 400.07349,338.62746 297.85625,404.64846 194.50231,471.40365 52.545601,440.30284 -14.107713,337.09343 -81.495143,232.74727 -50.09354,89.432951 54.108046,22.14733 159.44642,-45.872342 304.11836,-14.169944 372.03629,91.023817 440.6882,197.35441 408.68501,343.38396 302.49907,411.9342 195.17627,481.21836 47.78909,448.91436 -21.393449,341.73625 -91.309851,233.42124 -58.705063,84.676438 49.465223,14.861594 158.77246,-55.687052 308.87487,-22.781468 379.32202,86.380995 450.50291,196.68044 417.29653,348.14048 307.14189,419.21993 195.85023,491.03307 43.03257,457.52589 -28.679185,346.37908 -101.12457,234.0952 -67.316592,79.919916 44.8224,7.5758585 158.09849,-65.501771 313.6314,-31.392997 386.60776,81.738172 460.31763,196.00647 425.90806,352.89701 311.78472,426.50567 196.52421,500.84779 38.276042,466.13742 -35.96492,351.0219 -110.93929,234.76918 -75.928125,75.163386 40.179577,0.29012271 157.42451,-75.316497 318.38793,-40.004532 393.89349,77.095349 470.13236,195.3325 434.5196,357.65354 316.42754,433.7914 197.19818,510.66252 33.519507,474.74896 -43.250656,355.66472 -120.75402,235.44315 -84.539662,70.406849 35.536755,-6.9956131 156.75053,-85.13123 323.14447,-48.61607 401.17923,72.452526 479.9471,194.65852 443.13114,362.41008 321.07036,441.07714 197.87216,520.47726 28.762965,483.3605 -50.536392,360.30755 -130.56876,236.11714 -93.151204,65.650305 30.893932,-14.281349 156.07655,-94.94597 327.90101,-57.227613 408.46497,67.809703 489.76184,193.98453 451.74268,367.16663 325.71319,448.36288 198.54615,530.292 24.006417,491.97205 -57.822128,364.95037 -140.38351,236.79112 -101.76275,60.893756 26.251109,-21.567085 155.40256,-104.76071 332.65757,-65.839159 415.7507,63.16688 499.57658,193.31054 460.35423,371.92318 330.35601,455.64861 199.22014,540.10675 19.249863,500.58359 -65.107864,369.59319 -150.19825,237.46511 -110.3743,56.137201 21.608286,-28.852821 154.72857,-114.57547 337.41412,-74.450708 423.03644,58.524057 509.39134,192.63655 468.96578,376.67974 334.99883,462.93435 199.89413,549.9215 14.493304,509.19514 -72.3936,374.23601 -160.01301,238.1391 -118.98585,51.380641 16.965463,-36.138556 154.05458,-124.39022 342.17068,-83.06226 430.32217,53.881234 519.20609,191.96256 477.57733,381.4363 339.64165,470.22008 200.56812,559.73626 9.7367412,517.8067 -79.679335,378.87884 -169.82777,238.8131 -127.5974,46.624077 12.32264,-43.424292 153.38058,-134.20498 346.92725,-91.673815 437.60791,49.238411 529.02085,191.28856 486.18889,386.19287 344.28448,477.50582 201.24212,569.55102 4.9801738,526.41825 -86.965071,383.52166 -179.64253,239.4871 -136.20896,41.867508 7.6798172,-50.710028 152.70658,-144.01974 351.68382,-100.28537 444.89364,44.595589 538.83562,190.61456 494.80044,390.94944 348.9273,484.79156 201.91612,579.36579 0.22360259,535.02981 -94.250807,388.16448 -189.4573,240.1611 -144.82052,37.110936 3.0369943,-57.995764 152.03258,-153.83451 356.44039,-108.89693 452.17938,39.952766 548.65039,189.94056 503.412,395.70601 353.57012,492.07729 202.59013,589.18055 -4.5329722,543.64137 -101.53654,392.80731 -199.27206,240.8351 -153.43208,32.354361 -1.6058285,-65.2815 151.35858,-163.64928 361.19697,-117.50849 459.46512,35.309943 558.46516,189.26655 512.02357,400.46259 358.21295,499.36303 203.26413,598.99533 -9.2895503,552.25293 -108.82228,397.45013 -209.08684,241.50911 -162.04364,27.597782 -6.2486514,-72.567236 150.68457,-173.46405 365.95355,-126.12006 466.75085,30.66712 568.27993,188.59255 520.63513,405.21917 362.85577,506.64876"
       transform="translate(409.57143,114.28571)"
       id="fill-swirl"
       style="fill:none;stroke:#000000;stroke-width:1;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1; display:none;" />

  <line
         x1="2"
         y1="2"
         x2="3"
         y2="2"
         id="drawpoint"
         style="fill:none;stroke:red;stroke-width:5;stroke-linecap:round" />
</svg>

<canvas  height="738" width="1000" id="simulate"></canvas>

<script>

  var $path = {};
  var $fillPath = {};
  var index = 1;
  var penStat = {};
  var $svg = $('#main');
  var height = $svg.height();
  var width = $svg.width();
  var stopDraw = false;
  var stopBuildFill = false;
  var precision = Number($('#precision').val());
  var svgOffset = $svg.offset();
  var maxPaintDistance = 8000;

  // Convert the polys and lines to path
  // TODO: This happens after load, or before print... :|
  changeToPaths();

  // Get initial pen data from machine
  getPenStat();

  // Bind all SVG element click / select
  $('svg *:not(g)').on('click', function(e){
    if ($path.length) {
      $path.removeClass('selected');
    }
    $path = $(this);
    $path.addClass('selected');
    $path.transformMatrix = this.getTransformToElement(this.ownerSVGElement);
    index = 0;

    console.log($path);

    e.stopPropagation(); // Don't bubble up and select groups
  });

  // Select Fill Path and set matrix
  $fillPath = $('svg #fill-swirl');
  $fillPath.transformMatrix = $fillPath[0].getTransformToElement($fillPath[0].ownerSVGElement);
  // Bind to Tool Change nav items
  $('nav#tools a').click(function(e){
    toolChange(this.id);
    if ($(this).is('.color')){
      $('nav#tools a.selected').removeClass('selected');
      $(this).addClass('selected');
    }
  });

  // Bind to control buttons
  $('#park').click(function(){ parkPen(); });
  $('#movefirst').click(function(){ penUp(readyFirstPoint); });
  $('#draw').click(function(){
    if (stopDraw === 0) {
      stopDraw = true;
    } else {
      stopDraw = 0;
      $('#draw').text('STOP Draw');
      drawNextPoint();
    }
  });
  $('#pen-up').click(function(){ penUp() });
  $('#pen-down').click(function(){ penDown(); });
  $('#disable').click(function(){ disableMotors(); });
  $('#precision').change(function(){ precision = Number($(this).val()); });

  // Bind to fill controls
  $('#fill-build').click(function(){
    // stopBuildFill is 0 if running
    if (stopBuildFill === 0) {
      stopBuildFill = true;
    } else {
      stopBuildFill = 0;
      simulatePathFill($('#fills select').val());
    }
  });

  $('#fill-paint').click(function(){
    // stopDraw is 0 if running
    if (stopDraw === 0) {
      stopDraw = true;
    } else {
      stopdraw = 0;
      drawFill();
    }
  });


  // Convert everything to paths
  function changeToPaths() {
    var polys = document.querySelectorAll('polygon,polyline');
    [].forEach.call(polys, convertPolyToPath);

    var lines = document.querySelectorAll('line');
    [].forEach.call(lines, convertLineToPath);

    function convertPolyToPath(poly){
      var svgNS = poly.ownerSVGElement.namespaceURI;
      var path = document.createElementNS(svgNS,'path');
      var points = poly.getAttribute('points').split(/\s+|,/);
      var x0=points.shift(), y0=points.shift();
      var pathdata = 'M'+x0+','+y0+'L'+points.join(' ');
      if (poly.tagName=='polygon') {
        pathdata+='z';
      }

      path.setAttribute('d',pathdata);

      path.setAttribute('style', poly.style.cssText);
      path.setAttribute('id', poly.id);
      poly.parentNode.replaceChild(path,poly);
    }

    function convertLineToPath(line){
      // Don't convert our drawpoint
      // TODO: Add the point after load or something to avoid this :P
      if (line.id == 'drawpoint'){
        return;
      }
      var svgNS = line.ownerSVGElement.namespaceURI;
      var path = document.createElementNS(svgNS,'path');
      path.setAttribute('d', 'M'+
        line.getAttribute('x1')+','+
        line.getAttribute('y1')+' L'+
        line.getAttribute('x2')+','+
        line.getAttribute('y2'));
      path.setAttribute('style', line.style.cssText);
      path.setAttribute('id', line.id);
      line.parentNode.replaceChild(path, line);
    }
  }

  function readyFirstPoint() {
    moveTo($path[0].getPointAtLength(0).matrixTransform($path.transformMatrix));
  }

  // Outlines all visible portions of a given path, one step at a time
  function drawNextPoint(){
    if (stopDraw) {
      stopDraw = false;
      $('#draw').text('Draw Path');
      penUp();
      return;
    }

    index+= precision;
    if (index > $path[0].getTotalLength()) {
      console.log('Path Complete!');
      index = 0;
      penUp();
      return;
    }

    var point = $path[0].getPointAtLength(index).matrixTransform($path.transformMatrix);

    // Only ignore the pen timeout if we've been drawing
    // TODO: This is probably still a bad idea
    point.ignoreTimeout = (penStat.distanceCounter == 0 ? 0 : 1);

    // With each coordinate, check to see that the path is visible
    getPenStatePathCollide($path[0], point, function(){
      moveTo(point, function(data){

        // If we've used this one too much, go get more paint!
        if (data.distanceCounter > maxPaintDistance) {
          getMorePaint(point, function(){
            index-= precision * 5; // Draw backwards three steps
            drawNextPoint();
          });
        } else {
          drawNextPoint();
        }

      });
    });
  }

  // Find out what DOM object is directly below the point given
  // Will NOT work if point is outside visible screen range!
  function getPointPathCollide(point) {
    return document.elementFromPoint(point.x+svgOffset.left+2, point.y+svgOffset.top+2);
  }

  // Set the pen down or up based on visibility of a given path at a given point
  // TODO: Document this function
  function getPenStatePathCollide(path, point, callback) {
    // Drawpoint element can get in the way of elementFromPoint, hide it!
    $('#drawpoint').hide();
    var coordPath = getPointPathCollide(point);
    $('#drawpoint').show();

    if (coordPath) {
      // TODO: Check via something other than ID
      if (coordPath.id == path.id){
        // Correct path, visible at this coordinate!!
        // If Pen isn't down, put it down, then continue!
        if (penStat.state == 0){
          penDown(function(){
            callback();
          });
        } else{
          callback();
        }
      } else {
        // Wrong path!
        console.log('Path Hidden by ', coordPath.id);

        // If Pen is down, put it up, then continue!
        if (penStat.state == 1){
          penUp(function(){
            callback();
          });
        } else {
          callback();
        }
      }
    } else {
      console.log('Point not visible!: ', point);
      callback();
    }
  }

  // Wet the brush and get more of selected paint color, then return to
  // point given and trigger callback
  function getMorePaint(point, callback) {
    toolChange('water1', function(){
      toolChange($('.color.selected').attr('id'), function(){
        penUp(function(){
          moveTo(point, callback);
        });
      });
    });
  }

  // Build all coordinates for filling a path
  function simulatePathFill(fillStyle) {
    var point = {};
    var lastPoint = {};
    var fillIndex = 0;
    var fillPrecision = 10;
    var max = $fillPath[0].getTotalLength();
    var queueIndex = 0;
    var fillSpacing = 8; // Only used for horizontal or vertical fillStyle
    var pathRect = $path[0].getBoundingClientRect();

    $('#fill-build').text('STOP Build');

    // Clear canvas and set visual options
    $('canvas#simulate')[0].width = $('canvas#simulate').width();
    var can = $('canvas#simulate')[0].getContext('2d');
    can.strokeStyle = '#999';
    can.lineWidth  = 6;

    if (!fillStyle) {
      fillStyle = 'path';
    }

    // Other fill styles..
    if (fillStyle == 'horizontal') {
      max = (height / fillSpacing) * width;
      fillPrecision = 10;

      // Start the fillIndex at the Bounding Box TOP
      var top = pathRect.top;
      fillIndex = (top / fillSpacing) * width;
    }

    if (fillStyle == 'vertical') {
      max = (width / fillSpacing) * height;
      fillPrecision = 10;

      var left = pathRect.left;
      fillIndex = (left / fillSpacing) * height;
    }

    fillQueue = [];
    fillQueue[0] = [];

    $path.removeClass('selected');
    $('#drawpoint').hide();
    $('nav#fills progress').attr({max: max, value: 0});

    simulateNextPathFillStep();

    function simulateNextPathFillStep(){
      // Follow a given selected path to trace to make the fill
      if (fillStyle == 'path') {
        point = $fillPath[0].getPointAtLength(fillIndex).matrixTransform($fillPath.transformMatrix);
      } else if (fillStyle == 'horizontal') {
        // Hatch back and forth lines across the full width to the bottom

        // Get the number of full widths done so far
        var fillWidths = parseInt(fillIndex / width);

        // Our fillIndex less any full widths crossed, gives us any leftover
        point.x = fillIndex - (fillWidths * width);

        // Alternate directions
        if (fillWidths % 2) {
          point.x = width - point.x;
        }

        // How many widths we've gone so far, multiply that by the fillspacing for height
        point.y = fillWidths * fillSpacing;

        // Short circuit if point is beyond bottom of path
        if (point.y > pathRect.bottom) {
          fillIndex = max;
        }

      } else if (fillStyle == 'vertical') {
        // Hatch up and down lines the full height to the right

        // Get the number of full heights done so far
        var fillHeights = parseInt(fillIndex / height);

        // Our fillIndex less any full heights crossed, gives us any leftover
        point.y = fillIndex - (fillHeights * height);

        // Alternate directions
        if (fillHeights % 2) {
          point.y = height - point.y;
        }

        // How many heights we've gone so far, multiply that by the fillspacing for width
        point.x = fillHeights * fillSpacing;

        // Short circuit if point is beyond bottom of path
        if (point.x > pathRect.right) {
          fillIndex = max;
        }
      }

      // Assume it's a good point!
      var validPoint = true;

      // Simple sanity check to see that point inside the bounds of the
      if (point.x < pathRect.left || point.x > pathRect.right) {
        validPoint = false;
      }

      if (point.y < pathRect.top || point.y > pathRect.bottom) {
        validPoint = false;
      }

      // If we still think it's valid, use the slow visual path collision check
      if (validPoint) {
        validPoint = getPointPathCollide(point).id == $path[0].id
      }

      if (validPoint){
        if (lastPoint.x) {
          can.moveTo(lastPoint.x, lastPoint.y);
          can.lineTo(point.x, point.y);
          can.stroke();
        }

        // Add point to queue
        fillQueue[queueIndex].push({x: point.x, y: point.y});

        lastPoint.x = point.x;
        lastPoint.y = point.y;
      } else { // No match! Clear lastPoint

        // Just moved away from a draw point, move to next queue index and clear point
        if (lastPoint.x) {
          queueIndex++;
          fillQueue[queueIndex] = [];
          lastPoint = {};
        }
      }
      fillIndex+= fillPrecision;

      $('nav#fills progress').attr('value', fillIndex);

      // Done! (or quit)
      if (fillIndex > max || stopBuildFill) {
        fillIndex = 0;

        // Bring back these defaults
        $path.addClass('selected'); // Show selection
        $('#drawpoint').show(); // Show drawpoint
        $('#fill-build').text('Build Fill'); // Reset button text
        stopBuildFill = false;
        $('nav#fills progress').attr('value', 0); // Clear progress

        if (!stopBuildFill) {
          console.log('Path fill done!')
          $path.data('fill', fillQueue); // Pass the draw queue into the element
          $('#fill-paint').prop('disabled', false); // Enable paint button
        }
      } else {
        // Run Again! Waits 1 ms, lets browser do other things
        setTimeout(simulateNextPathFillStep, 1);
      }
    }
  }


  // Actually draw the pre-built fill path points
  function drawFill(){
    var fillQueue = $path.data('fill');
    var fillGroupIndex = 0;
    var fillIndex = 0;
    var point = {};

    $('#fill-paint').text('STOP Draw');

    penUp(drawNextFillPath);

    // Iteratively draw next path in queue
    function drawNextFillPath(){

      // Done Painting! or stopped
      if (typeof fillQueue[fillGroupIndex] == "undefined" || stopDraw) {
        stopDraw = false;
        $('#fill-paint').text('Paint Fill');
        penUp();
      }

      moveTo(fillQueue[fillGroupIndex][fillIndex], function(data){
        penDown(function(){
          fillIndex++;

          // Moved beyond group contents, move to next group
          if (fillIndex > fillQueue[fillGroupIndex].length -1) {
            fillIndex = 0;
            fillGroupIndex++;
            // Move to next path after raising pen
            penUp(drawNextFillPath);
          } else { // Actually painting...
            if (penStat.distanceCounter > maxPaintDistance) {
              console.log('Time to go get more paint!');
              getMorePaint(fillQueue[fillGroupIndex][fillIndex-1], function(){
                console.log('Resuming fill painting');
                drawNextFillPath();
              });
            } else {
              drawNextFillPath();
            }
          }
        });
      });


    }
  }

  // Get the pen x/y status
  function getPenStat(){
    $.ajax({
      url: '/pen',
      type: 'GET',
      success: function(d){
        penStat = d;
      }
    });
  }

  function penUp(callback){
    $.ajax({
      url: '/pen',
      type: 'PUT',
      data: { // 0 is off, don't draw
        state: 0
      },
      success: function(d){
        penStat = d;
        if (callback) callback(d);
      }
    });
  }

  function penDown(callback) {
    $.ajax({
      url: '/pen',
      type: 'PUT',
      data: { // 1 is on, do draw
        state: 1
      },
      success: function(d){
        penStat = d;
        if (callback) callback(d);
      }
    });
  }

  function penResetCounter(callback) {
    $.ajax({
      url: '/pen',
      type: 'PUT',
      data: {
        resetCounter: true
      },
      success: function(d){
        penStat = d;
        if (callback) callback();
      }
    });
  }

  function moveTo(point, callback){
    if (point == undefined){
      if (callback) callback(false);
      return;
    }

    // Move visible drawpoint
    $('#drawpoint').attr({
      x1:point.x-2,
      y1:point.y-2,
      x2:point.x+2,
      y2:point.y+2
    });

    var percent = {
      x: (point.x / width) * 100,
      y: (point.y / height) * 100
    }

    // Sanity check outputs
    percent.x = percent.x > 100 ? 100 : percent.x;
    percent.y = percent.y > 100 ? 100 : percent.y;
    percent.x = percent.x < 0 ? 0 : percent.x;
    percent.y = percent.y < 0 ? 0 : percent.y;


    $.ajax({
      url: '/pen',
      type: 'PUT',
      data: { // Send as percentage
        x: percent.x,
        y: percent.y,
        ignoreTimeout: point.ignoreTimeout
      },
      success: function(d){
        penStat = d;
        if (callback) callback(d);
      }
    });
  }

  function parkPen(callback){
    $.ajax({
      url: '/pen',
      type: 'DELETE',
      success: function(d){
        if (callback) callback();
      }
    });
  }

  function disableMotors(callback){
    $.ajax({
      url: '/motors',
      type: 'DELETE',
      success: function(d){
        if (callback) callback();
      }
    });
  }

  function toolChange(toolName, callback){
    $.ajax({
      url: '/tools/' + toolName,
      type: 'PUT',
      success: function(d){
        penResetCounter(function (){
          if (callback) callback(d);
        });
      }
    });
  }

</script>

</body>
</html>

